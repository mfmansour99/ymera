"""
YMERA Enterprise v4.0 - Main Application
Production-ready AI Agent Orchestration Platform
"""

from fastapi import FastAPI, Request, status
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.gzip import GZipMiddleware
from fastapi.responses import JSONResponse
from contextlib import asynccontextmanager
import logging
import sys
from pathlib import Path

# Add app directory to Python path
sys.path.insert(0, str(Path(__file__).parent / "app"))

# Import core modules
from CORE_CONFIGURATION.config_manager import ConfigManager
from app.VECTOR_DATABASES.knowledge_graph import KnowledgeGraph, KnowledgeGraphConfig
from app.PATTERN_RECOGNITION.pattern_recognition import PatternRecognitionEngine, PatternRecognitionConfig
from app.AGENT_MANAGEMENT.agent_integration import ProductionAgentLearningIntegrator, AgentLearningConfig
from app.LEARNING_ENGINE.external_learning import ProductionExternalLearningProcessor, ExternalLearningConfig
from app.LEARNING_ENGINE.memory_consolidation import ProductionMemoryConsolidator, MemoryConsolidationConfig
from app.MONITORING_HEALTH.metrics_collector import MetricsCollector
from app.CORE_ENGINE.core_engine import LearningEngine as CoreEngine

from app.CACHING_PERFORMANCE.redis_cache_manager import RedisCacheManager, CacheConfig
from app.DATABASE_CORE.database_connection import DatabaseManager, DatabaseConfig
from app.LOGGING_SYSTEM.logging_config import setup_logging
from app.MONITORING_HEALTH.health_check import HealthCheck
from API_GATEWAY_CORE_ROUTES.ymera_api_gateway import create_api_router

# Import agent systems
from AGENT_MANAGEMENT.agent_manager import AgentManager
from CORE_AGENT_FRAMEWORK.orchestration_agent import OrchestrationAgent
from ENHANCED_AGENTS.enhanced_llm_agent import EnhancedLLMAgent
from PRODUCTION_MONITORING.prod_monitoring_core import ProductionMonitoring

# Setup logging
logger = setup_logging()

# Global instances
config_manager = None
core_engine = None
agent_manager = None
cache_manager = None
health_check = None
monitoring = None
db_manager_instance = None


@asynccontextmanager
async def lifespan(app: FastAPI):
    """Application lifespan manager"""
    global config_manager, core_engine, agent_manager, cache_manager, health_check, monitoring
    
    logger.info("üöÄ Starting YMERA Enterprise v4.0...")
    
    try:
        # Initialize configuration
        logger.info("üìã Loading configuration...")
        config_manager = ConfigManager()
        await config_manager.load_config()
        
        # Initialize core engine
        logger.info("‚öôÔ∏è Initializing core engine...")
        from app.CORE_ENGINE.core_engine import LearningEngineConfig
        learning_engine_config = LearningEngineConfig(
            enabled=config_manager.config.agents.learning_enabled,
            learning_cycle_interval=config_manager.config.agents.learning_interval,
            # Add other LearningEngineConfig fields as needed, or default them
        )
        # Initialize Redis Cache Manager
        redis_cache_manager = RedisCacheManager(CacheConfig())
        await redis_cache_manager.initialize()

        # Initialize metrics collector
        metrics_collector = MetricsCollector(redis_client=redis_cache_manager.redis_client)
        await metrics_collector.initialize()

        core_engine = CoreEngine(
            config=learning_engine_config,
            knowledge_graph=KnowledgeGraph(KnowledgeGraphConfig()),
            pattern_engine=PatternRecognitionEngine(PatternRecognitionConfig()),
            agent_integration=ProductionAgentLearningIntegrator(AgentLearningConfig()),
            external_learning=ProductionExternalLearningProcessor(ExternalLearningConfig()),
            memory_consolidation=ProductionMemoryConsolidator(MemoryConsolidationConfig()),
            metrics_collector=metrics_collector
        )


        await core_engine.initialize()
        
        # Initialize database
        logger.info("üíæ Initializing database manager...")

        db_manager_instance = DatabaseManager(DatabaseConfig(database_url=config_manager.get_database_url()))
        await db_manager_instance.initialize()
        
        # Initialize Redis cache
        logger.info("üîÑ Connecting to Redis...")
        cache_manager = RedisCacheManager(config_manager.get_redis_config())
        await cache_manager.connect()
        
        # Initialize agent manager
        logger.info("ü§ñ Initializing agent system...")
        agent_manager = AgentManager(core_engine, cache_manager)
        await agent_manager.initialize()
        
        # Initialize production monitoring
        logger.info("üìä Starting production monitoring...")
        monitoring = ProductionMonitoring(config_manager)
        await monitoring.start()
        
        # Initialize health check
        logger.info("üè• Setting up health checks...")
        health_check = HealthCheck(
            database=db_manager_instance,
            redis=cache_manager,
            agents=agent_manager
        )
        
        logger.info("‚úÖ YMERA Enterprise v4.0 started successfully!")
        logger.info(f"üìç Environment: {config_manager.get_environment()}")
        logger.info(f"üåê API Base URL: {config_manager.get_api_base_url()}")
        
        yield
        
    except Exception as e:
        logger.error(f"‚ùå Startup failed: {e}", exc_info=True)
        raise
    
    finally:
        # Cleanup
        logger.info("üõë Shutting down YMERA Enterprise...")
        
        if monitoring:
            await monitoring.stop()
        
        if agent_manager:
            await agent_manager.shutdown()
        
        if cache_manager:
            await cache_manager.disconnect()
        
        if core_engine:
            await core_engine.shutdown()
        
        logger.info("üëã YMERA Enterprise stopped")


# Create FastAPI application
app = FastAPI(
    title="YMERA Enterprise API",
    description="AI Agent Orchestration Platform",
    version="4.0.0",
    docs_url="/api/docs",
    redoc_url="/api/redoc",
    openapi_url="/api/openapi.json",
    lifespan=lifespan
)

# Add middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Configure in production
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

app.add_middleware(GZipMiddleware, minimum_size=1000)


# Global exception handler
@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    logger.error(f"Unhandled exception: {exc}", exc_info=True)
    return JSONResponse(
        status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
        content={
            "error": "Internal server error",
            "message": str(exc) if app.debug else "An unexpected error occurred",
            "path": str(request.url)
        }
    )


# Health check endpoint
@app.get("/health")
async def health():
    """Health check endpoint"""
    if health_check:
        return await health_check.check()
    return {"status": "starting"}


# Root endpoint
@app.get("/")
async def root():
    """Root endpoint"""
    return {
        "name": "YMERA Enterprise API",
        "version": "4.0.0",
        "status": "operational",
        "docs": "/api/docs"
    }


# Include API routers
api_router = create_api_router(agent_manager, core_engine, cache_manager)
app.include_router(api_router, prefix="/api/v1")


if __name__ == "__main__":
    import uvicorn
    
    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=8000,
        reload=False,  # Set to True for development
        log_level="info"
    )

